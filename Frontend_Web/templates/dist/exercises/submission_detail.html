<!DOCTYPE html>
<html lang="en">

<head>
  <title>Submission Detail | APR-CV</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="APR-CV Physical Therapy Management System">
  <meta name="keywords" content="PT, Physical Therapy, Rehab, Patient Management">
  <meta name="author" content="APR-CV Team">

  <link rel="icon" href="/static/assets/images/favicon.svg" type="image/x-icon"> 
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" id="main-font-link">
  <link rel="stylesheet" href="/static/assets/fonts/tabler-icons.min.css">
  <link rel="stylesheet" href="/static/assets/fonts/feather.css">
  <link rel="stylesheet" href="/static/assets/fonts/fontawesome.css">
  <link rel="stylesheet" href="/static/assets/fonts/material.css">
  <link rel="stylesheet" href="/static/assets/css/style.css" id="main-style-link">
  <link rel="stylesheet" href="/static/assets/css/style-preset.css">
</head>

<body data-pc-preset="preset-1" data-pc-direction="ltr" data-pc-theme="light">
  <div class="loader-bg">
    <div class="loader-track">
      <div class="loader-fill"></div>
    </div>
  </div>

  <!-- Sidebar navigation -->
  <nav class="pc-sidebar">
    <div class="navbar-wrapper">
      <div class="m-header">
        <a href="/front-page" class="b-brand text-primary">
          <i class="ti ti-medical-cross fs-4"></i>
          <span class="ms-2 fw-bold">APR-CV</span>
        </a>
      </div>
      <div class="navbar-content">
        <ul class="pc-navbar">
          <li class="pc-item">
            <a href="/front-page" class="pc-link">
              <span class="pc-micon"><i class="ti ti-dashboard"></i></span>
              <span class="pc-mtext">Dashboard</span>
            </a>
          </li>
        
          <li class="pc-item pc-hasmenu">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-users"></i></span>
              <span class="pc-mtext">Patients</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/patients">Patient Directory</a></li>
              <li class="pc-item"><a class="pc-link" href="/reports/patients">Patient Reports</a></li>
            </ul>
          </li>
        
          <li class="pc-item pc-hasmenu">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-calendar"></i></span>
              <span class="pc-mtext">Appointments</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/appointments">Schedule</a></li>
            </ul>
          </li>
        
          <li class="pc-item pc-hasmenu active">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-activity"></i></span>
              <span class="pc-mtext">Exercise Library</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/exercises">Browse Exercises</a></li>
              <li class="pc-item"><a class="pc-link" href="/exercises/add">Upload New Exercise</a></li>
              <li class="pc-item"><a class="pc-link active" href="/exercises/submissions">Patient Submissions</a></li>
            </ul>
          </li>
        
          <li class="pc-item pc-hasmenu">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-report"></i></span>
              <span class="pc-mtext">Treatment Plans</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/treatment-plans/new">Create Plan</a></li>
              <li class="pc-item"><a class="pc-link" href="/treatment-plans">Manage Plans</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Header -->
  <header class="pc-header">
    <div class="header-wrapper">
      <div class="me-auto pc-mob-drp">
        <ul class="list-unstyled">
          <li class="pc-h-item pc-sidebar-collapse">
            <a href="#!" class="pc-head-link">
              <i class="ti ti-menu-2"></i>
            </a>
          </li>
          <li class="pc-h-item pc-sidebar-popup">
            <a href="#!" class="pc-head-link">
              <i class="ti ti-menu-2"></i>
            </a>
          </li>
        </ul>
      </div>

      <div class="ms-auto">
        <ul class="list-unstyled">
          <li class="dropdown pc-h-item">
            <a class="pc-head-link dropdown-toggle arrow-none me-0"
               data-bs-toggle="dropdown"
               href="#!"
               role="button"
               aria-haspopup="false"
               aria-expanded="false">
              <i class="ti ti-mail"></i>
              {% if unread_messages_count > 0 %}
              <span class="badge bg-danger pc-h-badge dots"><span class="sr-only">{{ unread_messages_count }} unread messages</span></span>
              {% endif %}
            </a>
            <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown">
              <div class="dropdown-header d-flex align-items-center justify-content-between">
                <h5 class="m-0">Messages{% if unread_messages_count > 0 %} <span class="badge bg-light-danger text-danger">{{ unread_messages_count }} New</span>{% endif %}</h5>
                <a href="#!" class="pc-head-link bg-transparent"><i class="ti ti-x text-danger"></i></a>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-header px-0 text-wrap header-notification-scroll position-relative" style="max-height: calc(100vh - 215px)">
                <div class="list-group list-group-flush w-100">
                  {% if recent_messages %}
                    {% for message in recent_messages %}
                    <a href="/messages/{{ message.message_id }}" class="list-group-item list-group-item-action">
                      <div class="d-flex">
                        <div class="flex-shrink-0">
                          <img src="/static/assets/images/user/{{ message.profile_image }}" alt="user-image" class="user-avtar">
                        </div>
                        <div class="flex-grow-1 ms-1">
                          <span class="float-end text-muted">{{ message.time_display }}</span>
                          <p class="text-body mb-1">{{ message.content|truncate(60) }}</p>
                          <span class="text-muted">{{ message.time_ago }}</span>
                        </div>
                      </div>
                    </a>
                    {% endfor %}
                  {% else %}
                    <div class="text-center p-3">
                      <p class="text-muted">No new messages</p>
                    </div>
                  {% endif %}
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="text-center py-2">
                <a href="/messages" class="link-primary">View all messages</a>
              </div>
            </div>
          </li>
          <li class="dropdown pc-h-item header-user-profile">
            <a class="pc-head-link dropdown-toggle arrow-none me-0"
              data-bs-toggle="dropdown"
              href="#!"
              role="button"
              aria-haspopup="false"
              data-bs-auto-close="outside"
              aria-expanded="false">
              <img src="/static/assets/images/user/{{ therapist.profile_image }}" alt="user-image" class="user-avtar">
              <span>{{ first_name }} {{ last_name }}</span>
            </a>
            <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
              <div class="dropdown-header">
                <div class="d-flex mb-1">
                  <div class="flex-shrink-0">
                    <img src="/static/assets/images/user/{{ therapist.profile_image }}" alt="user-image" class="user-avtar">
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">{{ first_name }} {{ last_name }}</h6>
                    <span>Physical Therapist</span>
                  </div>
                  <a href="/logout" class="pc-head-link bg-transparent"><i class="ti ti-power text-danger"></i></a>
                </div>
              </div>
              <ul class="nav drp-tabs nav-fill nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="drp-t1"
                    data-bs-toggle="tab"
                    data-bs-target="#drp-tab-1"
                    type="button"
                    role="tab"
                    aria-controls="drp-tab-1"
                    aria-selected="true"
                    ><i class="ti ti-user"></i> Profile</button
                  >
                </li>
              </ul>
              <div class="tab-content" id="mysrpTabContent">
                <div class="tab-pane fade show active" id="drp-tab-1" role="tabpanel" aria-labelledby="drp-t1" tabindex="0">
                  <a href="/profile/edit" class="dropdown-item">
                    <i class="ti ti-edit-circle"></i>
                    <span>Edit Profile</span>
                  </a>
                  <a href="/profile" class="dropdown-item">
                    <i class="ti ti-user"></i>
                    <span>View Profile</span>
                  </a>
                  <a href="/profile/reviews" class="dropdown-item">
                    <i class="ti ti-star"></i>
                    <span>My Reviews</span>
                  </a>
                  <a href="/logout" class="dropdown-item">
                    <i class="ti ti-power"></i>
                    <span>Logout</span>
                  </a>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </header>
  
  <div class="pc-container">
    <div class="pc-content">
      <!-- Breadcrumbs -->
      <div class="page-header">
        <div class="page-block">
          <div class="row align-items-center">
            <div class="col-md-12">
              <div class="page-header-title">
                <h5 class="m-b-10">Exercise Submission Detail</h5>
              </div>
              <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="/front-page">Home</a></li>
                <li class="breadcrumb-item"><a href="/exercises/submissions">Patient Submissions</a></li>
                <li class="breadcrumb-item" aria-current="page">{{ submission.exercise_name }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="row">
        <!-- Left sidebar with patient details -->
        <div class="col-md-12 col-xl-4">
          <div class="card">
            <div class="card-header">
              <h5>Submission Details</h5>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="avtar avtar-l">
                  <span>{{ submission.first_name[0] }}{{ submission.last_name[0] }}</span>
                </div>
                <div class="ms-3">
                  <h5 class="mb-1">{{ submission.first_name }} {{ submission.last_name }}</h5>
                  <p class="mb-0 text-muted">Patient ID: PT-{{ submission.patient_id }}</p>
                </div>
              </div>
              <hr>
              <div class="row">
                <div class="col-12 mb-3">
                  <p class="mb-1 text-muted">Exercise</p>
                  <h6>{{ submission.exercise_name }}</h6>
                </div>
                <div class="col-12 mb-3">
                  <p class="mb-1 text-muted">Treatment Plan</p>
                  <h6>{{ submission.plan_name }}</h6>
                </div>
                <div class="col-6 mb-3">
                  <p class="mb-1 text-muted">Submission Date</p>
                  <h6>{{ submission.submission_date.strftime('%Y-%m-%d') }}</h6>
                </div>
                <div class="col-6 mb-3">
                  <p class="mb-1 text-muted">Status</p>
                  {% if submission.status == 'Pending' %}
                    <span class="badge bg-light-warning text-warning">Pending</span>
                  {% elif submission.status == 'Reviewed' %}
                    <span class="badge bg-light-info text-info">Reviewed</span>
                  {% elif submission.status == 'Feedback Provided' %}
                    <span class="badge bg-light-success text-success">Feedback Provided</span>
                  {% endif %}
                </div>
                {% if submission.notes %}
                <div class="col-12 mb-3">
                  <p class="mb-1 text-muted">Patient Notes</p>
                  <div class="bg-light p-3 rounded">
                    <p class="mb-0">{{ submission.notes }}</p>
                  </div>
                </div>
                {% endif %}
              </div>
              <hr>
              <div class="row">
                <div class="col-12">
                  <div class="d-flex align-items-center justify-content-between">
                    <a href="/patients/{{ submission.patient_id }}" class="btn btn-outline-primary">
                      <i class="ti ti-user me-1"></i> Patient Profile
                    </a>
                    <a href="/exercises/submissions" class="btn btn-outline-primary">
                      <i class="ti ti-arrow-left me-1"></i> Back to List
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Previous Submissions -->
          {% if previous_submissions %}
          <div class="card">
            <div class="card-header">
              <h5>Previous Submissions</h5>
            </div>
            <div class="card-body">
              <div class="list-group">
                {% for prev in previous_submissions %}
                <a href="/exercises/submissions/{{ prev.submission_id }}" class="list-group-item list-group-item-action">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1">{{ prev.exercise_name }}</h6>
                      <p class="mb-0 text-muted">{{ prev.submission_date.strftime('%Y-%m-%d') }}</p>
                    </div>
                    {% if prev.status == 'Pending' %}
                      <span class="badge bg-light-warning text-warning">Pending</span>
                    {% elif prev.status == 'Reviewed' %}
                      <span class="badge bg-light-info text-info">Reviewed</span>
                    {% elif prev.status == 'Feedback Provided' %}
                      <span class="badge bg-light-success text-success">Feedback Provided</span>
                    {% endif %}
                  </div>
                </a>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Main content area -->
        <div class="col-md-12 col-xl-8">
          <!-- Original Exercise Video -->
          <div class="card mb-4">
            <div class="card-header">
              <h5>Original Exercise Video</h5>
            </div>
            <div class="card-body">
              <div class="ratio ratio-16x9 mb-4">
                {% if submission.video_url %}
                <video id="original-video" controls class="rounded">
                  <source src="{{ submission.video_url }}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
                {% else %}
                <div class="alert alert-warning">
                  No video available for this submission.
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Pose Detection Analysis -->
          <div class="card mb-4">
            <div class="card-header">
              <h5>Pose Detection Analysis</h5>
            </div>
            <div class="card-body">
              {% if submission.has_processed_video %}
              <!-- Already processed video exists -->
              <div class="ratio ratio-16x9 mb-4">
                <video id="processed-video" controls class="rounded" preload="metadata">
                  <source src="{{ submission.processed_video_url }}" type="video/mp4">
                  Your browser does not support the video tag or the video format.
                </video>
              </div>
              <div class="alert alert-info mb-3">
                <i class="ti ti-info-circle me-2"></i>
                The video above shows a pose detection analysis that highlights body movement patterns.
              </div>
              <div class="d-flex justify-content-between">
                <button onclick="regenerateVideo()" class="btn btn-outline-primary">
                  <i class="ti ti-refresh me-1"></i> Regenerate Analysis
                </button>
                <a href="{{ submission.processed_video_url }}" download class="btn btn-primary">
                  <i class="ti ti-download me-1"></i> Download Analysis
                </a>
              </div>
              {% else %}
              <!-- No processed video yet -->
              <div id="pose-detection-controls">
                <div class="alert alert-info mb-4">
                  <i class="ti ti-info-circle me-2"></i>
                  Generate a pose detection analysis to visualize and evaluate the patient's form and movement patterns.
                </div>
                <div class="text-center">
                  <button id="process-video-btn" class="btn btn-primary" data-submission-id="{{ submission.submission_id }}">
                    <i class="ti ti-wand me-1"></i> Generate Pose Detection Video
                  </button>
                </div>
              </div>
              
              <!-- Processing indicator (initially hidden) -->
              <div id="processing-indicator" style="display: none;">
                <div class="text-center my-5">
                  <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Processing...</span>
                  </div>
                  <p class="mb-2">Processing video with pose detection...</p>
                  <p class="text-muted small">This may take several minutes depending on the video length.</p>
                  <button id="stop-processing-btn" class="btn btn-warning mt-3">
                    <i class="ti ti-player-stop me-1"></i> Stop Processing & Save Current Progress
                  </button>
                </div>
              </div>
              
              <!-- Processed video container (initially hidden) -->
              <div id="processed-video-container" style="display: none;">
                <!-- Content will be inserted by JavaScript when processing is complete -->
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Feedback Section -->
          <div class="card">
            <div class="card-header">
              <h5>Feedback</h5>
            </div>
            <div class="card-body">
              {% if submission.status == 'Feedback Provided' %}
                <div>
                  <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0 me-2">Rating:</h6>
                    <span class="badge 
                      {% if submission.feedback_rating == 'Excellent' %}
                        bg-success
                      {% elif submission.feedback_rating == 'Good' %}
                        bg-info
                      {% elif submission.feedback_rating == 'Needs Improvement' %}
                        bg-warning
                      {% elif submission.feedback_rating == 'Poor' %}
                        bg-danger
                      {% endif %}
                      ">{{ submission.feedback_rating }}</span>
                    <span class="ms-auto text-muted small">Provided on {{ submission.feedback_date.strftime('%Y-%m-%d') }}</span>
                  </div>
                  <div class="bg-light p-3 rounded">
                    <p class="mb-0">{{ submission.therapist_feedback }}</p>
                  </div>
                </div>
              {% else %}
                <div>
                  <form action="/exercises/submissions/{{ submission.submission_id }}/feedback" method="post">
                    <div class="mb-3">
                      <label for="rating" class="form-label">Rating</label>
                      <select class="form-select" id="rating" name="rating" required>
                        <option value="" selected disabled>Select a rating</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Needs Improvement">Needs Improvement</option>
                        <option value="Poor">Poor</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="feedback" class="form-label">Feedback Comments</label>
                      <textarea class="form-control" id="feedback" name="feedback" rows="5" required
                                placeholder="Provide detailed feedback on form, technique, improvements needed, etc."></textarea>
                    </div>
                    <div class="text-end">
                      <button type="submit" class="btn btn-primary">
                        <i class="ti ti-send me-1"></i> Submit Feedback
                      </button>
                    </div>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer -->
  <footer class="pc-footer">
    <div class="footer-wrapper container-fluid">
      <div class="row">
        <div class="col-auto my-1">
          <ul class="list-inline footer-link mb-0">
          </ul>
        </div>
      </div>
    </div>
  </footer>
  
  <!-- Core JS Scripts -->
  <script src="/static/assets/js/plugins/popper.min.js"></script>
  <script src="/static/assets/js/plugins/simplebar.min.js"></script>
  <script src="/static/assets/js/plugins/bootstrap.min.js"></script>
  <script src="/static/assets/js/fonts/custom-font.js"></script>
  <script src="/static/assets/js/pcoded.js"></script>
  <script src="/static/assets/js/plugins/feather.min.js"></script>

  <script>layout_change('light');</script>
  <script>change_box_container('false');</script>
  <script>layout_rtl_change('false');</script>
  <script>preset_change("preset-1");</script>
  <script>font_change("Public-Sans");</script>

  <!-- Pose Detection Processing Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get the submission ID from the page
      const submissionIdElem = document.querySelector('[data-submission-id]');
      const SUBMISSION_ID = submissionIdElem ? 
                          submissionIdElem.dataset.submissionId : 
                          window.location.pathname.split('/').pop();
      
      console.log("Submission ID:", SUBMISSION_ID);
      
      // DOM element references
      const processBtn = document.getElementById('process-video-btn');
      const stopBtn = document.getElementById('stop-processing-btn');
      const poseDetectionControls = document.getElementById('pose-detection-controls');
      const processingIndicator = document.getElementById('processing-indicator');
      const processedVideoContainer = document.getElementById('processed-video-container');
      
      // Helper functions for UI management
      function showElement(element) {
        if (element) element.style.display = 'block';
      }
      
      function hideElement(element) {
        if (element) element.style.display = 'none';
      }
      
      // Initialize global functions for access across the script
      window.checkProcessingStatus = checkProcessingStatus;
      window.updateProgressBar = updateProgressBar;
      window.stopVideoProcessing = stopVideoProcessing;
      window.regenerateVideo = regenerateVideo;
      
      // Add event listeners
      if (processBtn) {
        processBtn.addEventListener('click', function() {
          console.log("Process button clicked for submission ID:", SUBMISSION_ID);
          hideElement(poseDetectionControls);
          showElement(processingIndicator);
          startVideoProcessing();
        });
      }
      
      if (stopBtn) {
        stopBtn.addEventListener('click', function() {
          console.log("Stop button clicked");
          stopBtn.disabled = true;
          stopBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Stopping...';
          stopVideoProcessing();
        });
      }
      
      // Function to start video processing
      function startVideoProcessing() {
        console.log("Starting video processing...");
        
        fetch('/api/process_exercise_video/' + SUBMISSION_ID, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Process response:", data);
          
          if (data.status === 'already_processed') {
            // Video is already processed, show it
            const url = data.download_url || data.processed_video_url;
            showProcessedVideo(url);
          } 
          else if (data.status === 'processing') {
            // Video is being processed, start checking status
            addProgressBar();
            updateProgressBar(0);
            setTimeout(checkProcessingStatus, 3000);
          } 
          else {
            throw new Error(data.message || "Unknown response from server");
          }
        })
        .catch(error => {
          console.error('Error starting video processing:', error);
          
          // Show error message
          hideElement(processingIndicator);
          showElement(poseDetectionControls);
          
          // Remove any existing error messages
          const existingErrors = poseDetectionControls.querySelectorAll('.alert-danger');
          existingErrors.forEach(el => el.remove());
          
          // Add new error message
          const errorDiv = document.createElement('div');
          errorDiv.className = 'alert alert-danger mt-3';
          errorDiv.innerHTML = `
            <i class="ti ti-alert-triangle me-2"></i>
            <strong>Error:</strong> ${error.message || "Failed to process video"}
          `;
          poseDetectionControls.appendChild(errorDiv);
        });
      }
      
      // Add progress bar to the processing indicator
      function addProgressBar() {
        const statusText = processingIndicator.querySelector('p.mb-2');
        if (!statusText) return;
        
        // Check if progress bar already exists
        if (!processingIndicator.querySelector('.progress')) {
          const progressHTML = `
            <div class="progress mt-3 mb-3" style="height: 20px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" aria-valuenow="0" aria-valuemin="0" 
                   aria-valuemax="100" style="width: 0%">0%</div>
            </div>
          `;
          statusText.insertAdjacentHTML('afterend', progressHTML);
        }
      }
      
      // Update progress bar
      function updateProgressBar(percent) {
        addProgressBar();
        
        const progressBar = processingIndicator.querySelector('.progress-bar');
        if (progressBar) {
          progressBar.style.width = percent + '%';
          progressBar.setAttribute('aria-valuenow', percent);
          progressBar.textContent = percent + '%';
        }
        
        const statusText = processingIndicator.querySelector('p.mb-2');
        if (statusText) {
          statusText.textContent = `Processing video with pose detection... ${percent}% complete`;
        }
      }
      
      // Check processing status
      function checkProcessingStatus() {
        console.log("Checking processing status...");
        
        fetch('/api/processed_video_status/' + SUBMISSION_ID)
          .then(response => response.json())
          .then(data => {
            console.log("Status check data:", data);
            
            // Update progress if available
            if (data.percent_complete !== undefined) {
              updateProgressBar(data.percent_complete);
            }
            
            if (data.ready && (data.download_url || data.processed_video_url)) {
              // Processing complete, show the video
              const url = data.download_url || data.processed_video_url;
              showProcessedVideo(url);
            } else if (data.is_processing) {
              // Still processing, check again soon
              // Still processing, check again soon
              setTimeout(checkProcessingStatus, 3000);
            } else if (!data.ready && !data.is_processing) {
              // Something went wrong
              showError("Processing completed but no video was generated. This may be due to codec issues.");
            }
          })
          .catch(error => {
            console.error('Error checking processing status:', error);
            // Try again after a longer delay
            setTimeout(checkProcessingStatus, 5000);
          });
      }
      
      // Show processed video completion and download button
function showProcessedVideo(url) {
  hideElement(processingIndicator);
  showElement(processedVideoContainer);
  
    processedVideoContainer.innerHTML = `
      <div class="alert alert-success mb-4">
        <i class="ti ti-check me-2"></i> Pose detection analysis complete!
      </div>
      <div class="bg-light p-5 rounded text-center mb-4">
        <i class="ti ti-file-video mb-3" style="font-size: 48px; color: #4680FF;"></i>
        <h5 class="mb-3">Pose Detection Analysis Ready</h5>
        <p class="mb-4">The pose detection analysis has been successfully generated. Click the button below to download and view the analysis.</p>
        <a href="${url}" class="btn btn-primary btn-lg" download>
          <i class="ti ti-download me-1"></i> Download Video
        </a>
      </div>
      <div class="d-flex justify-content-end mt-2">
        <button onclick="regenerateVideo()" class="btn btn-outline-primary">
          <i class="ti ti-refresh me-1"></i> Regenerate Analysis
        </button>
      </div>
    `;
  }
      
      // Stop video processing
      function stopVideoProcessing() {
        console.log("Stopping video processing...");
        
        fetch('/api/stop_exercise_video_processing/' + SUBMISSION_ID, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          console.log("Stop response:", data);
          
          if (data.status === 'stopped' && (data.download_url || data.processed_video_url)) {
            // Show whatever video was processed so far
            const url = data.download_url || data.processed_video_url;
            showProcessedVideo(url);
          } else {
            // Show error or message
            hideElement(processingIndicator);
            showElement(poseDetectionControls);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-warning mt-3';
            messageDiv.innerHTML = `
              <i class="ti ti-info-circle me-2"></i>
              ${data.message || "Processing was stopped, but no video could be created."}
            `;
            
            // Remove any existing messages
            const existingMessages = poseDetectionControls.querySelectorAll('.alert');
            existingMessages.forEach(el => el.remove());
            
            poseDetectionControls.appendChild(messageDiv);
          }
        })
        .catch(error => {
          console.error('Error stopping video processing:', error);
          hideElement(processingIndicator);
          showElement(poseDetectionControls);
          showError("Error stopping processing: " + error.message);
        });
      }
      
      // Show error message
      function showError(message) {
        hideElement(processingIndicator);
        showElement(poseDetectionControls);
        
        // Remove any existing error messages
        const existingErrors = poseDetectionControls.querySelectorAll('.alert-danger');
        existingErrors.forEach(el => el.remove());
        
        // Add new error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.innerHTML = `<i class="ti ti-alert-triangle me-2"></i> ${message}`;
        poseDetectionControls.appendChild(errorDiv);
      }
      
      // Regenerate video function
      function regenerateVideo() {
        console.log("Regenerate function called");
        
        if (confirm('Are you sure you want to regenerate the pose detection analysis?')) {
          // Get the button and show loading state
          const btn = document.querySelector('.btn-outline-primary');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
          btn.disabled = true;
          
          fetch('/api/regenerate_exercise_video/' + SUBMISSION_ID, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(response => {
            if (!response.ok) throw new Error(`Server returned ${response.status}`);
            return response.json();
          })
          .then(data => {
            console.log("Regenerate API response:", data);
            
            // Hide video player, show processing indicator
            if (processedVideoContainer) processedVideoContainer.style.display = 'none';
            if (processingIndicator) {
              processingIndicator.style.display = 'block';
              
              // Make sure progress bar exists
              addProgressBar();
              updateProgressBar(0);
              
              // Check if stop button exists, if not add it
              if (!processingIndicator.querySelector('#stop-processing-btn')) {
                const stopBtnHTML = `
                  <button id="stop-processing-btn" class="btn btn-warning mt-3">
                    <i class="ti ti-player-stop me-1"></i> Stop Processing & Save Current Progress
                  </button>
                `;
                processingIndicator.querySelector('.text-center').insertAdjacentHTML('beforeend', stopBtnHTML);
                
                const newStopBtn = document.getElementById('stop-processing-btn');
                if (newStopBtn) {
                  newStopBtn.addEventListener('click', function() {
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Stopping...';
                    stopVideoProcessing();
                  });
                }
              }
              
              // Start checking status
              setTimeout(checkProcessingStatus, 3000);
            }
          })
          .catch(error => {
            console.error('Error regenerating video:', error);
            alert('Error: ' + error.message);
            
            // Restore button state
            btn.innerHTML = originalText;
            btn.disabled = false;
          });
        }
      }
      
      // Initialize - check if currently processing
      const hasProcessedVideo = document.querySelector('#processed-video') !== null;
      if (!hasProcessedVideo && SUBMISSION_ID) {
        // Check if processing is in progress
        fetch('/api/processed_video_status/' + SUBMISSION_ID)
          .then(response => response.json())
          .then(data => {
            console.log("Initial status check:", data);
            
            if (data.is_processing) {
              // Already processing, show the indicator
              if (poseDetectionControls) poseDetectionControls.style.display = 'none';
              if (processingIndicator) processingIndicator.style.display = 'block';
              
              // Add progress bar
              addProgressBar();
              updateProgressBar(data.percent_complete || 0);
              
              // Start checking for updates
              setTimeout(checkProcessingStatus, 3000);
            }
            else if (data.ready && (data.download_url || data.processed_video_url)) {
              // Already processed, show the video
              const url = data.download_url || data.processed_video_url;
              showProcessedVideo(url);
            }
          })
          .catch(error => {
            console.error("Error checking initial processing status:", error);
          });
      }
    });
  </script>
</body>
</html>